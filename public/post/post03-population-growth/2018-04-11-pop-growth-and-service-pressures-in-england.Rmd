---
title: 'Population growth and service pressures in England'
Summary: 'This is where the summary text goes'
author: 'Steve Doogue'
date: '2018-04-11'
slug: population-growth-and-pressure
categories: []
tags: []
thumbnailImagePosition: "left"
thumbnailImage: //res.cloudinary.com/ddjmrpbw4/image/upload/v1523463010/population600.jpg
comments: true

---

```{r, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}
# PACKAGES ----

library(tidyverse)
library(readxl)
library(scales)
library(ggrepel)

# For the mapping:
library(geojsonio)
library(leaflet)
library(spdplyr) # Allows you to manipulate spatial data frame using dplyr verbs

```
```{r, echo = FALSE, message = FALSE}
# LOAD AND ORGANISE DATA ----

# Clear workspace

rm(list = ls())

# Read in population data
df_pop <-   read_csv('data/pop_data.csv') 

# Read in local authority information data and change data types
df_info <-  read_xlsx('data/la_info.xlsx') %>%
            mutate_at(vars(5:6,8),as.factor) 

  # Change factor levels
  df_info$admin <- fct_collapse(df_info$admin, London = c('ILB','OLB'))
  df_info$admin <- fct_relevel(df_info$admin, 'London', 'County', 'Unitary', 'MD') 
  df_info$admin <- recode(df_info$admin, 'MD' = 'Met', 'SD' = 'Shire district')

# Read in spending data
df_spend <- read_xlsx('data/spending.xlsx') %>%
            filter(name != 'Iles of Scilly') %>% 
  
            # Gather age bands into single column
            gather(age_band,share,`0_17`:`all`) %>%
            arrange(code_mhclg) %>%
  
            # Create an ID column, based on authorty code and age band
            unite(id, code_mhclg, age_band,sep = " ", remove = FALSE) %>%
            select(-id,id)

```
```{r, echo = FALSE}

# DATAFRAMES TO BE USED

# Merge the population data with spending shares and LA info

df_pop0 <- df_pop %>%
            
            # Create an ID column, based on authority code and age band
            unite(id, code_mhclg, age_band,sep = " ", remove = FALSE) %>%
  
            # Add the spending share from df_spend table (this is the same for every year)
            left_join(select(df_spend, id, share), by = 'id') %>%
            select(-id) %>% 
            
            # Add authority names and admin type from the df_info table
            left_join(select(df_info, code_mhclg, name, admin), by = 'code_mhclg') %>% 
  
            # Create user-friendly labels with the variable 'age_band2'
            mutate(age_band2 = case_when(
              age_band == '0_17' ~ 'Children',
              age_band == '18_64' ~'Younger Adults',
              age_band == '65plus' ~ 'Older Adults',
              age_band == 'all' ~'All Ages')
            ) %>% 
            mutate(age_band2 = 
              factor(age_band2, levels = c('Older Adults', 'Younger Adults' ,'Children','All Ages'))
              ) %>% 
          
            # Restrict years to 2025 and earlier. Remove outliers, missing data
            select(code_mhclg, name, admin, year, age_band, age_band2, everything()) %>% 
            filter(year <= 2025,
                   name != 'City of London' & name != 'Isles of Scilly')

# POPULATION GROWTH INDICES FOR:

# 1 - Individual council by year and age band. Unweighted.

df_pop1 <- df_pop0 %>%
            arrange(code_mhclg, year) %>%
            group_by(code_mhclg, age_band) %>% 
            mutate(change_unweighted = (number - first(number))/first(number) +1) %>%
            ungroup()

# 2 - Admin group by year and age band. Unweighted.

df_pop2 <- df_pop1 %>%
           group_by(admin, year, age_band, age_band2) %>%
           summarise(change_unweighted = mean(change_unweighted)) %>%
           ungroup() %>%
           mutate(
             label_unweighted = if_else(year == 2025, 
                                        as.character(percent(change_unweighted - 1)),
                                        "")
             )

# 3 - Individual council by year. Unweighted and weighted age bands.

df_pop3 <- df_pop1 %>%
            group_by(code_mhclg, name, admin, year) %>% 
            summarise(change_weighted = sum(change_unweighted * share),
                      change_unweighted = change_unweighted[age_band == 'all']
                      ) %>%
            ungroup()

# 4 - Admin group by year. Unweighted and weighted age bands.

df_pop4 <- df_pop3 %>%
            group_by(admin, year) %>%
            summarise(change_unweighted = mean(change_unweighted),
                      change_weighted = mean(change_weighted)) %>%
            ungroup() %>%
            mutate(
              label_unweighted = if_else(year == 2025, 
                                         as.character(percent(change_unweighted - 1)),
                                         ""),
              label_weighted = if_else(year == 2025, 
                                       as.character(percent(change_weighted - 1)),
                                       "")
              )

```

```{r, echo = FALSE, message = FALSE}
# FIRST PLOT

# Plot overall population growth (unweighted)
# We need two sets of data for this - one for individual authorities (a), and one summarised by admin type (b)

colorscheme <- c("#1569C7", "#f46d43", "#fec44f", "#1a9850", "red")

plot1  <- ggplot(data = df_pop4, 
                 aes(x = year, y = change_unweighted -1, text = change_unweighted, color = admin)
          ) +
          geom_line(data = df_pop3, aes(group = name), color = 'grey10', alpha = .15, size = .5) +
          facet_grid(~admin) +
          geom_line(size = 1.2) +
          theme_minimal() +
          theme(axis.text.x=element_text(angle = -90, hjust = 0),
                axis.title.x = element_blank(),
                legend.position = "none",
                panel.grid.major.x = element_blank()
                ) +
          scale_x_continuous(breaks= pretty_breaks()) +
          scale_y_continuous(labels=percent) +
          geom_text_repel(aes(label = label_unweighted), show.legend = F, color = 'black', segment.color = NA, nudge_y = .02)+
          geom_hline(yintercept = 0, size = 0.25) +
          scale_color_manual(values = colorscheme) +
          labs(
              y = "Cumulative change",
              title = paste("Population growth")
              )
          
plot1

```

These projections can be broken down by age band, to show the trajectories for children (ages 0 to 17), younger adults (ages 18 to 65) and older adults (ages 65 and over):

```{r, echo = FALSE, message = FALSE}

# SECOND PLOT


plot2  <- ggplot(data = df_pop2 %>% filter(age_band != 'all'), 
                 aes(x = year, y = change_unweighted -1, text = change_unweighted, color = admin)
                 ) +
          geom_line(data = df_pop1 %>%  filter(age_band != 'all'), 
                    aes(group = name), color = 'grey10', alpha = .15, size = .5) +
          facet_grid(age_band2 ~ admin) + # scales = "free_y"
          geom_line(size = 1) +
          theme_minimal() +
          theme(axis.text.x=element_text(angle = -90, hjust = 0),
                axis.title.x = element_blank(),
                legend.position = "none",
                panel.grid.major.x = element_blank()) +
          scale_x_continuous(breaks = pretty_breaks()) +
          scale_y_continuous(labels = percent) +
          # Use two labels - one for the transparent background, one for the text
          geom_label_repel(aes(label = label_unweighted), alpha = .3, color = NA, seed = 1)+
          geom_label_repel(aes(label = label_unweighted), 
                           alpha = 1, fill = NA, color = 'black', 
                           label.size = NA, segment.color = NA, seed = 1) +        
          geom_hline(yintercept = 0, size = 0.25) +
          scale_color_manual(values = colorscheme) +
          labs(
              y = "Cumulative change",
              title = paste("Population growth by age band")
              )
          
plot2

```
<br>
From the figure above, we can see that older adults (65+) are the fastest growing age group for all types of councils, followed by children (age 0-17). Younger adults (ages 18-64) are projected to grow relatively slowly. London stands out for the fact that it has the fastest population growth in all age categories, but particularly for younger adults and children. 

This shows average spending on the various age bands. We exclude spending on schools and public health. 

```{r, echo = FALSE, message = FALSE}

# THIRD PLOT

# Calculate average spending share by admin group

df_plot3 <- df_pop0 %>%
             group_by(admin, age_band2) %>%
             summarise(share = mean(share)) %>%
             filter(admin != 'Shire district')

plot3 <-  ggplot(data = df_plot3) + 
          geom_bar(aes(y = share, x = admin, fill = age_band2), alpha = .75, stat="identity") +
          theme_minimal() +
          scale_y_continuous(labels=percent) +
          labs(y = "Share of expenditure",
               title = paste("Average expenditure by age band"),
               subtitle = paste("Based on actual net current expenditure for 2014/15 to 2016/17")
               ) +
          theme(axis.title.x = element_blank(),
                panel.grid.major.x = element_blank(),
                axis.text.x = element_text(colour="black"),
                axis.text.y = element_blank(),
                legend.title=element_blank()) +
          scale_fill_manual(values = c('#2171b5','#6baed6','#bdd7e7','#969696')) +
          guides(fill = guide_legend(reverse=TRUE)) +
          geom_text(aes(y= share, x = admin, label = percent(round(share,2))), size = 3, position = position_stack(vjust = 0.5)) 

plot3

```
  
We create a single estimate of 'population pressure' by weighing population growth in each age band by its corresponding share of expenditure (for each individual council). 

```{r, echo = FALSE, message = FALSE}
# FOURTH PLOT

# This is exactly the same as plot1 but uses weighted data

plot4  <- ggplot(data = df_pop4, 
                 aes(x = year, y = change_weighted -1, text = change_weighted, color = admin)
          ) +
          geom_line(data = df_pop3, aes(group = name), color = 'grey10', alpha = .15, size = .5) +
          facet_grid(~admin) +
          geom_line(size = 1.2) +
          theme_minimal() +
          theme(axis.text.x=element_text(angle = -90, hjust = 0),
                axis.title.x = element_blank(),
                legend.position = "none",
                panel.grid.major.x = element_blank()
                ) +
          scale_x_continuous(breaks= pretty_breaks()) +
          scale_y_continuous(labels=percent) +
          geom_text_repel(aes(label = label_weighted), show.legend = F, color = 'black', segment.color = NA, nudge_y = .02)+
          geom_hline(yintercept = 0, size = 0.25) +
          scale_color_manual(values = colorscheme) +
          labs(
              y = "Cumulative change",
              title = paste("Estimated population pressure"),
              substite = paste("Population growth weighted by expenditure on each age band")
              )
          
plot4

```

Finally, we can illustrate how population pressure varies by geographic region. As can be seen, population pressures are greatest in the South, East and East Midlands.


```{r, echo = FALSE, message = FALSE, warning = FALSE}

# CREATE A MAP

url_base <- "https://api.mapbox.com/styles/v1/steverd/cj79lzfne8a582spgrmb0otyr/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1Ijoic3RldmVyZCIsImEiOiJ5T0hIMGU4In0.iRYeTkjtats3I4b2ZCBZVw"

map_county <- geojson_read('data/unitary_county_small.geojson', what = 'sp')
map_district <- geojson_read('data/unitary_district_small.geojson', what = 'sp')

temp <- df_pop3 %>%
        filter(year == 2025)

map_county <- map_county %>% 
              left_join(select(temp,code_mhclg,change_weighted), 
                        by = 'code_mhclg') %>%
              mutate(change_weighted = change_weighted -1)

map_district <- map_district %>% 
                left_join(select(temp, code_mhclg, change_weighted), 
                          by = 'code_mhclg') %>%
                mutate(change_weighted = change_weighted -1)

# Map 

bins <-  c(-.1,0,0.05,0.1,0.2,Inf)
pal_county <- colorBin("YlOrRd", domain = map_county$change_weighted, bins = bins)
pal_district <- colorBin("YlOrRd", domain = map_district$change_weighted, bins = bins)


leaflet() %>%
  addTiles(url_base) %>%
  # Unitaries & counties unweighted
  addPolygons(data = map_county, 
              fillColor = ~pal_county(change_weighted),
              fillOpacity = 0.7,
              group = 'Unitaries & counties',
              label = paste(map_county$name,
                            percent(map_county$change_weighted)),
              color = 'white',
              weight = 2,
              highlightOptions = highlightOptions(color = "black", weight =4,
                                                  bringToFront = TRUE)) %>%
   # Unitaries & districts unweighted
  addPolygons(data = map_district, 
              fillColor = ~pal_district(change_weighted),
              fillOpacity = 0.7,
              group = 'Unitaries & districts',
              label = paste(map_district$name, 
                            percent(map_district$change_weighted)),
              color = 'white',
              weight = 2,
              highlightOptions = highlightOptions(color = "black", weight = 4,
                                                  bringToFront = TRUE)) %>%
  # Layers control
  addLayersControl(
    baseGroups = c('Unitaries & counties','Unitaries & districts'),
    options = layersControlOptions(collapsed = FALSE)
  ) %>% 
  # Add a legend
  addLegend(pal = pal_county, values = map_county$change_weighted, opacity = 0.7, title = NULL,
                position = "bottomright")

```

```{r}

df_plot5 <- df_pop1 %>% 
            filter(year == 2025,
                   age_band == 'all',
                   admin != 'County') %>% 
            left_join(select(df_info, code_mhclg, region), by= 'code_mhclg')
            
plot5 <- ggplot(data = df_plot5,
                aes(x = region, y = change_unweighted - 1)) +
          geom_jitter(size = 3, alpha = .5) +
          theme_minimal() +
          scale_y_continuous(labels=percent) +
          geom_hline(yintercept = 0, size = 0.25) +
          scale_color_manual(values = 'blue') +
          labs(
              y = "Cumulative change",
              title = paste("Population growth by region")
              )
      
plot5
```